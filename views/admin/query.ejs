
<style>
  body {
    margin: 0;
    padding: 0;
    background-color: #252525;
    color: white;
    width: 100%;
    min-height: 100%;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th, td {
    border: 3px solid white;
    padding: 8px;
    text-align: left;
  }
  th {
    background-color: #333;
  }
  td {
    word-break: break-all;
  }
  .delete-btn {
    cursor: pointer;
    width: 5px;
  }
  .section-title {
    font-size: 1.5em;
    margin-top: 20px;
  }
</style>
</head>
<body>
<div id="section1">
  <div class="section-title">Section A</div>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Query</th>
        <th>@</th>
      </tr>
    </thead>
    <tbody id="section1-tbody">
    </tbody>
  </table>
</div>

<div id="section2">
  <div class="section-title">Section B</div>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Query</th>
        <th>@</th>
      </tr>
    </thead>
    <tbody id="section2-tbody">
    </tbody>
  </table>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const querySocket = io("/ws/dm/admin");

// Load existing queries on page load
fetch('/dm/admin/queries')
  .then(response => response.json())
  .then(queries => {
    queries.forEach(data => addQueryToTable(data));
  })
  .catch(error => console.error('Error loading queries:', error));

// Handle new queries from WebSocket
querySocket.on("new.query", data => {
  addQueryToTable(data);
  updateQueryCount(1);
});

// Add query to the appropriate section table
function addQueryToTable(data) {
  const sectionId = determineSection(data);
  const tbody = document.querySelector(`#${sectionId}-tbody`);
  const tr = document.createElement("tr");
  const td1 = document.createElement("td");
  td1.innerHTML = data.sender;
  tr.appendChild(td1);
  const td2 = document.createElement("td");
  td2.innerHTML = data.query;
  tr.appendChild(td2);
  const td3 = document.createElement("td");
  td3.className = 'delete-btn';
  td3.setAttribute("onclick", `deleteQuery("${data.sender}", "${data.query}", this)`);
  td3.innerHTML = "🗑️";
  tr.appendChild(td3);
  tbody.appendChild(tr);
}

// Determine which section the data belongs to
function determineSection(data) {
  // Example logic (replace with actual logic)
  if (data.sender.startsWith('A')) {
    return 'section1';
  } else {
    return 'section2';
  }
}

// Delete query
function deleteQuery(name, query, btn) {
  const parent = btn.parentNode;
  parent.remove();
  updateQueryCount(-1);

  fetch('/dm/admin/query', {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ name, query })
  })
  .catch(error => {
    console.error('There was a problem with the fetch operation:', error);
  });
}

// Update query count
function updateQueryCount(change) {
  let queryCountElement = document.querySelector("#queryCount");
  if (!queryCountElement) {
    const spanElement = document.createElement("span");
    spanElement.id = "queryCount";
    spanElement.className = "noticount__badge";
    const noticountElements = document.getElementsByClassName("noticount");
    if (noticountElements.length > 0) {
      noticountElements[0].appendChild(spanElement);
    } else {
      console.error("Element with class 'noticount' not found.");
    }
    queryCountElement = spanElement;
  }

  let currentCount = parseInt(queryCountElement.innerHTML);
  if (isNaN(currentCount)) {
    currentCount = 0;
  }
  currentCount += change;
  if (currentCount > 99) {
    currentCount = "99+";
  }
  queryCountElement.innerHTML = currentCount;
}

// WebSocket ping for connection status
function getWsPing__() {
  const beforePingTime = Date.now();
  querySocket.emit("ping", () => {
    const nowWsPing = Date.now() - beforePingTime;
    document.querySelector("#wsPingCount").textContent = `${nowWsPing} ms`;
  });
}
getWsPing__();
setInterval(getWsPing__, 10000);
</script>
</body>

